<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPA DE POLTRONAS</title>
    <link rel="icon" href="https://i.imgur.com/SJIQzFl.jpeg" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .bus-container {
            background-color: white;
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.016);
            max-width: 500px;
            width: 100%;
            border: 5px solid black;
            margin-bottom: 20px;
        }
        
        .bus-grid {
            display: grid;
            grid-template-columns: 1fr 40px 1fr;
            gap: 10px;
        }
        
        .seat-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .left-side {
            grid-column: 1;
            display: grid;
            row-gap: 30px;
        }

        .right-side {
            padding-bottom: 100px;
            grid-column: 3;
            display: grid;
            row-gap: 10px;
        }
        
        .aisle {
            grid-column: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: bold;
            color: #7f8c8d;
        }
        
        .seat {
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #2ecc71;
            color: white;
        }
        
        .seat:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        
        .seat.selected {
            background-color: #3498db !important;
            transform: scale(1.05) !important;
        }
        
        .seat.occupied {
            background-color: #e74c3c !important;
            cursor: not-allowed !important;
        }
        
        .seat.disabled {
            background-color: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
        }
        
        .toilet-container {
            grid-column: 3;
            grid-row: 2 / span 2;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            margin-top: -100px;
        }
        
        .toilet {
            width: 200px;
            height: 100px;
            background-color: #413dc0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            line-height: 1.3;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 3px;
        }

        /* Estilos do formulário de seleção */
        .form-row {
            margin: 8px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        label {
            font-weight: bold;
            min-width: 120px;
        }

        input, select {
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
            min-width: 180px;
        }

        button#btnMostrarFormulario {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Estilos do modal */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        #modalContent {
            background: white;
            border-radius: 8px;
            padding: 20px 30px;
            max-width: 500px;
            width: 90vw;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        #modalContent h3 {
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        #modalContent button {
            margin-top: 12px;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        #enviar {
            background-color: #4CAF50;
            color: white;
            margin-right: 10px;
        }

        #cancelar {
            background-color: #f44336;
            color: white;
        }

        .seat.preferencial {
          background-color: #f1c40f;
          color: #000;
      }
        
    </style>
</head>
<body>
    <h1>Sistema de Reserva de Poltronas - Renotur</h1>
    
    <div class="form-row">
        <label for="dataViagem">Data da Viagem:</label>
        <input type="date" id="dataViagem" />
        <label for="idOnibus">Ônibus:</label>
        <select id="idOnibus">
            <option value="">Selecione</option>
            <option value="Ônibus 1">Ônibus 1</option>
            <option value="Ônibus 2">Ônibus 2</option>
            <option value="Ônibus 3">Ônibus 3</option>
        </select>
    </div>
    
    <div class="bus-container">
        <div class="bus-grid" id="busLayout">
            <div class="left-side" id="leftSeats"></div>
            <div class="aisle">Corredor</div>
            <div class="right-side" id="rightSeats"></div>
            <div class="toilet-container">
                <div class="toilet">🚽<br>Banheiro</div>
            </div>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #2ecc71;"></div>
            <span>Disponível</span>
          </div>
        <div class="legend-item">
           <div class="legend-color" style="background-color: #f1c40f;"></div>
            <span>Preferencial</span>
          </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #3498db;"></div>
            <span>Selecionado</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #e74c3c;"></div>
            <span>Ocupado</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #9b59b6;"></div>
            <span>Banheiro</span>
        </div>
    </div>

    <button id="btnMostrarFormulario">Marcar Reserva</button>

    <div id="modal">
        <div id="modalContent">
            <h3>Formulário de Reserva</h3>
            <form id="formReserva"></form>
            <div style="text-align:center; margin-top:10px;">
                <button type="button" id="enviar">Enviar Reserva</button>
                <button type="button" id="cancelar">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração inicial do layout das poltronas
        document.addEventListener('DOMContentLoaded', function() {
            const leftSeats = document.getElementById('leftSeats');
            const rightSeats = document.getElementById('rightSeats');
            
            const seatLayout = [
                // Fileira 1-12 (esquerda: 1-2,5-6,9-10... | direita: 4-3,8-7,12-11...)
                { left: [1, 2], right: [4, 3] },
                { left: [5, 6], right: [8, 7] },
                { left: [9, 10], right: [12, 11] },
                { left: [13, 14], right: [16, 15] },
                { left: [17, 18], right: [20, 19] },
                { left: [21, 22], right: [24, 23] },
                { left: [25, 26], right: [28, 27] },
                { left: [29, 30], right: [32, 31] },
                { left: [33, 34], right: [36, 35] },
                { left: [37, 38], right: [40, 39] },
                { left: [41, 42], right: [44, 43] },
                { left: [45, 46], right: [48, 47] }
            ];
            
            seatLayout.forEach((row, rowIndex) => {
                // Criar container para fileira esquerda
                const leftRow = document.createElement('div');
                leftRow.className = 'seat-row';
                
                // Adicionar assentos da esquerda
                row.left.forEach(seatNum => {
                    const seat = createSeat(seatNum);
                    leftRow.appendChild(seat);
                });
                leftSeats.appendChild(leftRow);
                
                // Criar container para fileira direita
                const rightRow = document.createElement('div');
                rightRow.className = 'seat-row';
                
                // Adicionar assentos da direita
                row.right.forEach(seatNum => {
                    const seat = createSeat(seatNum);
                    
                    // Marcar poltrona 43 como desabilitada
                    if (seatNum === 0) {
                        seat.classList.add('disabled');
                    }
                    
                    rightRow.appendChild(seat);
                });
                
                rightSeats.appendChild(rightRow);
            });
            
            // Inicializa a lógica do backend
            initializeBackendLogic();
        });
        
        function createSeat(number) {
            const seat = document.createElement('button');
            seat.className = 'seat available';
            seat.textContent = number;
            seat.dataset.seat = number;
            
            // Marcar assentos ímpares como janela
            if (number % 2 === 1) {
                seat.style.borderRight = '3px solid #3498db';
            }
            
                // Marcar poltronas 1-4 como preferenciais
            if (number >= 1 && number <= 4) {
                seat.classList.add('preferencial');
            }
            
            return seat;
        }

        // ==================== LÓGICA DO BACKEND ====================
        function initializeBackendLogic() {
            const btnMostrar = document.getElementById('btnMostrarFormulario');
            const modal = document.getElementById('modal');
            const formReserva = document.getElementById('formReserva');
            const enviarBtn = document.getElementById('enviar');
            const cancelarBtn = document.getElementById('cancelar');
            const dataViagemInput = document.getElementById('dataViagem');
            const idOnibusSelect = document.getElementById('idOnibus');

            const seats = document.querySelectorAll('.seat');

            let debounceTimer = null;
            const cachePoltronas = {};

            function setLoading(isLoading) {
                if (isLoading) {
                    if (!document.getElementById('loadingOverlay')) {
                        const loadingDiv = document.createElement('div');
                        loadingDiv.id = 'loadingOverlay';
                        loadingDiv.style = `
                            position: fixed;
                            top: 0; left: 0;
                            width: 100vw; height: 100vh;
                            background: rgba(0,0,0,0.3);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            color: white;
                            font-size: 24px;
                            z-index: 11000;
                            user-select: none;
                        `;
                        loadingDiv.innerText = 'Carregando... ⏳';
                        document.body.appendChild(loadingDiv);
                    }
                } else {
                    const loadingDiv = document.getElementById('loadingOverlay');
                    if (loadingDiv) loadingDiv.remove();
                }
            }

            // Função para carregar poltronas ocupadas
            async function carregarPoltronasOcupadas() {
                const dataViagem = dataViagemInput.value;
                const idOnibus = idOnibusSelect.value;
                console.log("[DEBUG] carregarPoltronasOcupadas chamado com:", { dataViagem, idOnibus });

                if (!dataViagem || !idOnibus) {
                    console.log("[DEBUG] Data ou ônibus não selecionados, limpando ocupadas");
                    seats.forEach(seat => seat.classList.remove('occupied'));
                    return;
                }

                // limpa visual antes de carregar
                seats.forEach(seat => seat.classList.remove('occupied'));

                const cacheKey = `${dataViagem}_${idOnibus}`;
                if (cachePoltronas[cacheKey]) {
                    console.log("[DEBUG] Usando cache para poltronas ocupadas (chave):", cacheKey);
                    console.log("[DEBUG] Dados do cache:", cachePoltronas[cacheKey]);
                    marcarOcupadas(cachePoltronas[cacheKey]);
                    return;
                }

                setLoading(true);

                const filtros = [
                    { Column: "Data da viagem", Operator: "=", Value: dataViagem },
                    { Column: "ID Ônibus", Operator: "=", Value: idOnibus }
                ];
                console.log("[DEBUG] Filtros enviados:", filtros);

                try {
                    const res = await fetch(
                        `https://api.appsheet.com/api/v2/apps/2131dc2f-f9ac-4f09-9c3e-a8e1fcd6b192/tables/Detalhes/Action`,
                        {
                            method: 'POST',
                            headers: {
                                'ApplicationAccessKey': 'V2-A5mjo-PYxsn-rOTHI-obxJi-JLrjt-puLDr-sWsEH-1Y1Ju',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                Action: "Find",
                                Filters: filtros
                            })
                        }
                    );

                    console.log("[DEBUG] Resposta HTTP status:", res.status);

                    if (!res.ok) throw new Error("Erro na API: " + res.status);

                    const raw = await res.json();
                    console.log("[DEBUG] Dados brutos recebidos da API:", raw);

                    let rows = null;
                    if (Array.isArray(raw)) rows = raw;
                    else if (Array.isArray(raw.Rows)) rows = raw.Rows;
                    else if (raw.Result && Array.isArray(raw.Result.Rows)) rows = raw.Result.Rows;
                    else if (Array.isArray(raw.value)) rows = raw.value;
                    else if (raw.results && Array.isArray(raw.results)) rows = raw.results;
                    else {
                        const candidateKey = Object.keys(raw).find(k => Array.isArray(raw[k]));
                        if (candidateKey) {
                            console.log("[DEBUG] Encontrado array candidato em raw['" + candidateKey + "']");
                            rows = raw[candidateKey];
                        }
                    }

                    console.log("[DEBUG] Dados que serão passados para marcarOcupadas:", rows);

                    if (!Array.isArray(rows)) {
                        console.warn("[WARN] Não foi possível extrair array de linhas da resposta da API.");
                        cachePoltronas[cacheKey] = raw;
                        marcarOcupadas(raw);
                        return;
                    }

                    console.log("[DEBUG] Linhas extraídas:", rows.length, "exemplo:", rows.slice(0,3));
                    cachePoltronas[cacheKey] = rows;

                    marcarOcupadas(rows);
                } catch (err) {
                    console.error('[ERROR] Erro ao carregar poltronas ocupadas:', err);
                } finally {
                    setLoading(false);
                }
            }

            function normalizeString(s) {
                if (s == null) return "";
                return String(s).trim()
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
            }

            function toISODate(str) {
                if (!str) return null;
                const raw = String(str).trim();

                // já em ISO ou YYYY-MM-DDT...
                const isoMatch = raw.match(/^(\d{4}-\d{2}-\d{2})/);
                if (isoMatch) return isoMatch[1];

                // tenta new Date (cobre "2025-08-12T00:00:00", "Aug 12 2025", etc.)
                const parsed = new Date(raw);
                if (!isNaN(parsed)) return parsed.toISOString().slice(0, 10);

                // tenta DD/MM/YYYY ou MM/DD/YYYY
                const m = raw.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (m) {
                    const a = parseInt(m[1], 10), b = parseInt(m[2], 10), y = m[3];
                    let day, month;
                    // desambigua: se um dos números >12 é dia
                    if (a > 12) { day = a; month = b; }
                    else if (b > 12) { day = b; month = a; }
                    else {
                        // assumir padrão BR (DD/MM/YYYY)
                        day = a; month = b;
                    }
                    return `${y}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                }

                return null;
            }

            function marcarOcupadas(data) {
                console.log("[DEBUG] marcarOcupadas chamado com", data);

                // limpa ocupadas antes de marcar (garante estado consistente)
                seats.forEach(s => s.classList.remove('occupied'));

                const dataInputISO = toISODate(dataViagemInput.value);
                const idOnibusNorm = normalizeString(idOnibusSelect.value);

                console.log("[DEBUG] Data input ISO:", dataInputISO, "Ônibus normalized:", idOnibusNorm);

                if (!dataInputISO || !idOnibusNorm) {
                    console.warn("[WARN] data de input ou ônibus inválidos, nada será marcado", { dataInputISO, idOnibusNorm });
                    return;
                }

                if (!Array.isArray(data)) {
                    console.error("[ERROR] Esperado array em 'data' para marcarOcupadas, recebeu:", data);
                    return;
                }

                data.forEach(row => {
                    // tenta várias chaves possíveis (tabelas podem ter nomes diferentes)
                    const rawDate = row["Data da viagem"] ?? row["Data"] ?? row.Data ?? null;
                    const rawOnibus = row["ID Ônibus"] ?? row["ID Onibus"] ?? row["Onibus"] ?? row.Onibus ?? row["ID_Onibus"] ?? null;
                    const rawPoltrona = row["Poltrona"] ?? row.Poltrona ?? row.Seat ?? row.seat ?? null;

                    const rowDateISO = toISODate(rawDate);
                    const rowOnibusNorm = normalizeString(rawOnibus);
                    let poltrona = rawPoltrona == null ? "" : String(rawPoltrona).trim();

                    // extrai dígitos se houver (12.0 -> 12)
                    const digits = poltrona.match(/\d+/);
                    if (digits) poltrona = digits[0];

                    // logs quando faltar algo
                    if (!rowDateISO || !rowOnibusNorm || !poltrona) {
                        console.log("[DEBUG] Linha ignorada por campos faltando/invalidos:", {
                            rawDate, rowDateISO, rawOnibus, rowOnibusNorm, rawPoltrona, poltrona, row
                        });
                        return;
                    }

                    if (rowDateISO === dataInputISO && rowOnibusNorm === idOnibusNorm) {
                        const seatBtn = document.querySelector(`.seat[data-seat="${poltrona}"]`);
                        if (seatBtn) {
                            seatBtn.classList.add('occupied');
                            seatBtn.classList.remove('selected');
                            console.log(`[DEBUG] Marcada ocupada: ${poltrona}`);
                        } else {
                            console.warn(`[WARN] Poltrona ${poltrona} não encontrada no DOM`, row);
                        }
                    } else {
                        // log útil pra diagnosticar porque não bateu
                        console.log("[DEBUG] Linha não corresponde ao filtro:", {
                            rowDateISO, neededDate: dataInputISO,
                            rowOnibusNorm, neededOnibus: idOnibusNorm,
                            poltrona
                        });
                    }
                });
            }

            // ==================== Interação com poltronas (clique) ====================
            seats.forEach(seat => {
                seat.addEventListener('click', () => {
                    if (seat.classList.contains('occupied') || seat.classList.contains('disabled')) return;
                    seat.classList.toggle('selected');
                });
            });

            // ==================== Abrir modal com formulário para poltronas selecionadas ====================
            btnMostrar.addEventListener('click', () => {
                const selecionadas = Array.from(document.querySelectorAll('.seat.selected'));
                if (selecionadas.length === 0) {
                    alert('Selecione ao menos uma poltrona antes de marcar reserva!');
                    return;
                }

                // limpa formulário
                formReserva.innerHTML = '';

                // cria campos pra cada poltrona selecionada (fragmento pra performance)
                const frag = document.createDocumentFragment();
                selecionadas.forEach(seat => {
                    const seatNum = seat.dataset.seat;
                    const bloco = document.createElement('div');
                    bloco.classList.add('reserva-bloco');
                    bloco.style = 'border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:6px;';

                    bloco.innerHTML = `
                        <h4>Poltrona ${seatNum}</h4>

                        <div class="form-row">
                            <label for="nome-${seatNum}">Nome:</label>
                            <input type="text" id="nome-${seatNum}" name="nome-${seatNum}" placeholder="Nome completo" required />
                        </div>
                        <div class="form-row">
                            <label for="identidade-${seatNum}">Identidade:</label>
                            <input type="text" id="identidade-${seatNum}" name="identidade-${seatNum}" placeholder="Número da identidade" required />
                        </div>
                        <div class="form-row">
                            <label for="telefone-${seatNum}">Telefone:</label>
                            <input type="tel" id="telefone-${seatNum}" name="telefone-${seatNum}" placeholder="(XX) XXXXX-XXXX" required />
                        </div>
                        <div class="form-row">
                            <label for="embarque-${seatNum}">Local de Embarque:</label>
                            <input type="text" id="embarque-${seatNum}" name="embarque-${seatNum}" placeholder="Local de embarque" required />
                        </div>
                        <div class="form-row">
                            <label for="pagamento-${seatNum}">Forma de Pagamento:</label>
                            <input type="text" id="pagamento-${seatNum}" name="pagamento-${seatNum}" placeholder="Forma de pagamento" required />
                        </div>
                        <div class="form-row">
                            <label for="agencia-${seatNum}">Agência:</label>
                            <select id="agencia-${seatNum}" name="agencia-${seatNum}" required>
                                <option value="">Selecione</option>
                                <option value="Padre Paraiso">Padre Paraiso</option>
                                <option value="Itaipe">Itaipe</option>
                                <option value="Novo Cruzeiro">Novo Cruzeiro</option>
                            </select>
                        </div>
                    `;

                    frag.appendChild(bloco);
                });

                formReserva.appendChild(frag);
                modal.style.display = 'flex';
                // foco no primeiro input por usabilidade
                const firstInput = formReserva.querySelector('input, select');
                if (firstInput) firstInput.focus();
            });

            // ==================== Cancelar ====================
            cancelarBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // ==================== Enviar reservas ====================
            enviarBtn.addEventListener('click', async () => {
                // proteção simples: evita múltiplos cliques rápidos
                if (enviarBtn.disabled) return;

                const dataViagem = dataViagemInput.value;
                const idOnibus = idOnibusSelect.value;
                console.log("[DEBUG] Enviar reserva clicado", { dataViagem, idOnibus });

                if (!dataViagem) {
                    alert('Selecione a data da viagem antes de enviar a reserva.');
                    console.log("[ERROR] Data da viagem não selecionada");
                    return;
                }
                if (!idOnibus) {
                    alert('Selecione o ônibus antes de enviar a reserva.');
                    console.log("[ERROR] Ônibus não selecionado");
                    return;
                }

                const selecionadas = Array.from(document.querySelectorAll('.seat.selected'));
                console.log("[DEBUG] Poltronas selecionadas:", selecionadas.length);
                if (selecionadas.length === 0) {
                    alert('Nenhuma poltrona selecionada.');
                    modal.style.display = 'none';
                    console.log("[ERROR] Nenhuma poltrona selecionada ao enviar");
                    return;
                }

                // coletar dados das reservas com checagem se os inputs existem
                const reservas = [];
                for (const seat of selecionadas) {
                    const seatNum = seat.dataset.seat;

                    const elNome = document.getElementById(`nome-${seatNum}`);
                    const elId = document.getElementById(`identidade-${seatNum}`);
                    const elTel = document.getElementById(`telefone-${seatNum}`);
                    const elEmb = document.getElementById(`embarque-${seatNum}`);
                    const elPag = document.getElementById(`pagamento-${seatNum}`);
                    const elAg = document.getElementById(`agencia-${seatNum}`);

                    if (!elNome || !elId || !elTel || !elEmb || !elPag || !elAg) {
                        alert(`Erro interno: campos do formulário para poltrona ${seatNum} não encontrados. Reabra o modal e tente de novo.`);
                        console.error("[ERROR] campo(s) faltando no DOM para poltrona", seatNum, { elNome, elId, elTel, elEmb, elPag, elAg });
                        return;
                    }

                    const nome = elNome.value.trim();
                    const identidade = elId.value.trim();
                    const telefone = elTel.value.trim();
                    const embarque = elEmb.value.trim();
                    const pagamento = elPag.value.trim();
                    const agencia = elAg.value.trim();

                    console.log(`[DEBUG] Dados da poltrona ${seatNum}:`, { nome, identidade, telefone, embarque, pagamento, agencia });

                    if (!nome || !identidade || !telefone || !embarque || !pagamento || !agencia) {
                        alert(`Preencha todos os campos para a poltrona ${seatNum}, incluindo a agência.`);
                        console.log(`[ERROR] Campos incompletos para poltrona ${seatNum}`);
                        return;
                    }

                    reservas.push({
                        "Data da viagem": dataViagem,
                        "Poltrona": seatNum,
                        "ID Ônibus": idOnibus,
                        "Nome": nome,
                        "Identidade": identidade,
                        "Telefone": telefone,
                        "Embarque": embarque,
                        "Forma de pagamento": pagamento,
                        "Agência": agencia
                    });
                }

                if (reservas.length === 0) {
                    alert('Nenhuma reserva válida encontrada.');
                    return;
                }

                console.log("[DEBUG] Reservas a serem enviadas:", reservas);

                // preparar envio
                enviarBtn.disabled = true;
                cancelarBtn.disabled = true;
                setLoading(true);

                try {
                    // enviar sequencialmente: se falhar, interrompe e mostra erro
                    for (const reserva of reservas) {
                        console.log(`[DEBUG] Enviando reserva poltrona ${reserva.Poltrona}`, reserva);
                        const response = await fetch('https://api.appsheet.com/api/v2/apps/2131dc2f-f9ac-4f09-9c3e-a8e1fcd6b192/tables/Detalhes/Action', {
                            method: 'POST',
                            headers: {
                                'ApplicationAccessKey': 'V2-A5mjo-PYxsn-rOTHI-obxJi-JLrjt-puLDr-sWsEH-1Y1Ju',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                Action: "Add",
                                Properties: {},
                                Rows: [reserva]
                            })
                        });

                        console.log(`[DEBUG] Resposta API poltrona ${reserva.Poltrona}:`, response.status, response.statusText);

                        if (!response.ok) {
                            const text = await response.text().catch(()=>"(sem body)");
                            console.error(`[ERROR] Falha ao enviar reserva poltrona ${reserva.Poltrona}:`, response.status, text);
                            throw new Error(`Falha ao enviar reserva da poltrona ${reserva.Poltrona}: ${response.status} - ${text}`);
                        }
                    }

                    // se chegou aqui, todas enviadas
                    alert('Reservas enviadas com sucesso!');
                    modal.style.display = 'none';

                    // visualizar ocupadas localmente
                    selecionadas.forEach(seat => {
                        seat.classList.remove('selected');
                        seat.classList.add('occupied');
                    });

                    // invalidar cache e recarregar do servidor para garantir consistência real
                    const chave = `${dataViagem}_${idOnibus}`;
                    if (cachePoltronas[chave]) delete cachePoltronas[chave];
                    // aguarda um pouquinho pra garantir que o backend processou
                    setTimeout(() => carregarPoltronasOcupadas(), 300);

                } catch (err) {
                    alert('Erro ao enviar reservas: ' + err.message);
                    console.error('[ERROR] Erro ao enviar reservas:', err);
                } finally {
                    enviarBtn.disabled = false;
                    cancelarBtn.disabled = false;
                    setLoading(false);
                }
            });

            // Event listeners para atualização das poltronas ocupadas
            dataViagemInput.addEventListener('change', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    console.log("[DEBUG] Data da viagem alterada, recarregando poltronas ocupadas");
                    carregarPoltronasOcupadas();
                }, 500);
            });

            idOnibusSelect.addEventListener('change', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    console.log("[DEBUG] Ônibus alterado, recarregando poltronas ocupadas");
                    carregarPoltronasOcupadas();
                }, 500);
            });

            // Carrega as poltronas ocupadas ao iniciar
            window.addEventListener('load', () => {
                carregarPoltronasOcupadas();
            });
        }
    </script>
    <footer style="text-align:center; margin-top:20px;">
        &copy; 2025 Renotur Transporte Turístico LTDA
    </footer>
      
</body>
</html>
